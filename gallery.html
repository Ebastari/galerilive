
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MONTANA AI - Visual Archive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --glass: rgba(15, 23, 42, 0.9); }
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: #020617; 
      color: white; 
      margin: 0; 
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .glass-dark { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }

    .img-glow { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .img-glow:hover { filter: saturate(1.2) brightness(1.1); box-shadow: 0 0 30px rgba(59, 130, 246, 0.3); }

    @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-zoom { animation: zoomIn 0.3s ease-out forwards; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Transitions for the viewer */
    .viewer-image { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
    }
  }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
    import { createRoot } from 'react-dom/client';

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxOxKo348A23N-6vdRDWskgwP6a_y9NOrri6Jpde8hw-X7ZrvytimOVb0eK0VcaTjhbCg/exec';
    const ADMIN_PASS = '1212';

    const getImageUrl = (link, size = 'w800') => {
      const idMatch = String(link || "").match(/(?:id=|\/d\/|src=".*?id=)([^"&?/ ]+)/);
      return idMatch ? `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=${size}` : 'https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?w=600';
    };

    const getHealthColor = (status) => {
      const s = String(status || "").toLowerCase();
      if (s.includes('sehat')) return 'bg-emerald-500';
      if (s.includes('merana')) return 'bg-amber-500';
      return 'bg-red-500';
    };

    const PasswordModal = ({ isOpen, onSubmit, onCancel }) => {
      const [pass, setPass] = useState('');
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-[10000] flex items-center justify-center p-6 bg-black/95 backdrop-blur-xl">
          <div className="bg-white rounded-[2.5rem] p-10 max-w-sm w-full shadow-2xl animate-zoom">
            <div className="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-6 text-red-600">
              <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 00-2 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <h3 className="text-slate-900 font-black text-xl uppercase italic tracking-tighter text-center mb-2">PIN Keamanan</h3>
            <p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest text-center mb-8">Masukkan PIN untuk hapus data selamanya</p>
            <input 
              type="password" 
              autoFocus
              className="w-full bg-slate-100 border-none rounded-2xl py-5 px-6 text-center text-slate-900 font-black text-2xl tracking-[0.5em] mb-6 outline-none focus:ring-4 focus:ring-red-500/10"
              placeholder="****"
              value={pass}
              onChange={(e) => setPass(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && onSubmit(pass)}
            />
            <div className="flex flex-col gap-2">
              <button onClick={() => onSubmit(pass)} className="w-full bg-red-600 text-white rounded-2xl py-4 text-[10px] font-black uppercase shadow-xl shadow-red-500/30 active:scale-95 transition-all">Konfirmasi Hapus</button>
              <button onClick={onCancel} className="w-full py-4 text-[10px] font-black uppercase text-slate-400 hover:text-slate-600 transition-colors">Batal</button>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [data, setData] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [viewerIndex, setViewerIndex] = useState(null);
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [isDeleting, setIsDeleting] = useState(false);
      
      const touchStart = useRef(0);
      const touchEnd = useRef(0);

      const loadData = async () => {
        setIsLoading(true);
        try {
          const res = await fetch(`${APPS_SCRIPT_URL}?t=${Date.now()}`);
          const json = await res.json();
          setData(Array.isArray(json) ? json.reverse() : []);
        } catch (e) { console.error(e); }
        setIsLoading(false);
      };

      const handleDelete = async (pass) => {
        if (pass !== ADMIN_PASS) {
          alert("PIN Salah!");
          return;
        }
        setIsDeleting(true);
        setDeleteTarget(null);
        try {
          await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'delete', pohonId: String(deleteTarget) })
          });
          setViewerIndex(null);
          // Sync Delay to allow remote server processing
          setTimeout(loadData, 2500);
        } catch (e) { 
          alert("Gagal menghapus data."); 
          setIsDeleting(false);
        }
      };

      useEffect(() => { loadData(); }, []);

      const filtered = useMemo(() => {
        return data.filter(d => 
          String(d["No Pohon"]).toLowerCase().includes(search.toLowerCase()) ||
          String(d.Tanaman).toLowerCase().includes(search.toLowerCase()) ||
          String(d.Pengawas || "").toLowerCase().includes(search.toLowerCase())
        );
      }, [data, search]);

      const goNext = useCallback(() => {
        if (viewerIndex !== null && viewerIndex < filtered.length - 1) setViewerIndex(v => v + 1);
      }, [viewerIndex, filtered.length]);

      const goPrev = useCallback(() => {
        if (viewerIndex !== null && viewerIndex > 0) setViewerIndex(v => v - 1);
      }, [viewerIndex]);

      useEffect(() => {
        const handleKeys = (e) => {
          if (viewerIndex === null) return;
          if (e.key === 'ArrowRight') goNext();
          if (e.key === 'ArrowLeft') goPrev();
          if (e.key === 'Escape') setViewerIndex(null);
        };
        window.addEventListener('keydown', handleKeys);
        return () => window.removeEventListener('keydown', handleKeys);
      }, [viewerIndex, goNext, goPrev]);

      const activeItem = viewerIndex !== null ? filtered[viewerIndex] : null;

      const handleTouchStart = (e) => touchStart.current = e.targetTouches[0].clientX;
      const handleTouchMove = (e) => touchEnd.current = e.targetTouches[0].clientX;
      const handleTouchEnd = () => {
        if (touchStart.current - touchEnd.current > 70) goNext();
        if (touchStart.current - touchEnd.current < -70) goPrev();
      };

      return (
        <div className="min-h-screen pb-20">
          {/* Header Dashboard */}
          <div className="max-w-7xl mx-auto px-6 py-10">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 mb-12">
              <div className="flex items-center gap-5">
                <a href="index.html" className="bg-white/5 p-4 rounded-2xl hover:bg-white/10 border border-white/10 transition-all text-blue-400 group">
                  <svg className="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </a>
                <div>
                  <h1 className="text-4xl font-black italic uppercase tracking-tighter leading-none">Visual <span className="text-blue-500">Archive</span></h1>
                  <p className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] mt-2">Satellite Boundary Monitoring • {filtered.length} Records</p>
                </div>
              </div>
              
              <div className="w-full md:w-[400px] relative">
                <input 
                  type="text" 
                  placeholder="Cari ID, Spesies, atau Pengawas..."
                  className="w-full bg-slate-900 border border-white/10 rounded-[1.5rem] py-5 px-14 text-sm font-bold text-white outline-none focus:ring-4 focus:ring-blue-500/20 transition-all"
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                />
                <svg className="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
              </div>
            </div>

            {/* Content Display */}
            {isLoading ? (
              <div className="flex flex-col items-center justify-center py-48 gap-6 text-center">
                <div className="w-16 h-16 border-[6px] border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
                <p className="text-[11px] font-black uppercase text-blue-400 tracking-[0.5em] animate-pulse">Syncing Mission Database</p>
              </div>
            ) : filtered.length === 0 ? (
              <div className="text-center py-48 opacity-30">
                <svg className="w-20 h-20 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <p className="font-black uppercase tracking-[0.2em]">Tidak Ada Data Visual Ditemukan</p>
              </div>
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                {filtered.map((item, idx) => (
                  <div 
                    key={item["No Pohon"]}
                    className="group relative aspect-[3/4] bg-slate-900 rounded-[2.5rem] overflow-hidden border border-white/5 cursor-pointer shadow-2xl hover:-translate-y-2 transition-all duration-500 animate-in fade-in"
                    onClick={() => setViewerIndex(idx)}
                  >
                    <img src={getImageUrl(item["Link Drive"], 'w400')} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-all duration-700 group-hover:scale-110" loading="lazy" />
                    <div className="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/20 to-transparent opacity-80" />
                    
                    {/* Instant Delete UI */}
                    <button 
                      onClick={(e) => { e.stopPropagation(); setDeleteTarget(item["No Pohon"]); }} 
                      className="absolute top-5 right-5 p-3.5 bg-red-600/20 backdrop-blur-md rounded-2xl text-red-500 opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 hover:text-white border border-red-500/10"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>

                    <div className="absolute bottom-6 left-7 right-7">
                      <div className="flex items-center gap-2 mb-2"><span className={`w-2 h-2 rounded-full ${getHealthColor(item.Kesehatan)}`}></span><span className="text-[8px] font-black text-white uppercase tracking-widest">{item.Kesehatan}</span></div>
                      <h4 className="font-black text-lg uppercase tracking-tight truncate">#{item["No Pohon"]}</h4>
                      <p className="text-[10px] font-bold text-slate-400 uppercase truncate mt-0.5">{item.Tanaman}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Full Screen Immersive Viewer */}
          {activeItem && (
            <div 
              className="fixed inset-0 z-[5000] bg-black flex flex-col animate-in fade-in duration-300" 
              onTouchStart={handleTouchStart} 
              onTouchMove={handleTouchMove} 
              onTouchEnd={handleTouchEnd}
            >
              {/* Viewer UI Toolbar */}
              <div className="p-6 md:p-8 flex justify-between items-center z-10 bg-gradient-to-b from-black/80 to-transparent">
                <div className="bg-blue-600 px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase shadow-xl shadow-blue-500/30">Item {viewerIndex + 1} / {filtered.length}</div>
                <div className="flex gap-3">
                  <button 
                    onClick={() => setDeleteTarget(activeItem["No Pohon"])} 
                    className="bg-red-600 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase shadow-xl hover:bg-red-700 transition-all flex items-center gap-3"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    Hapus
                  </button>
                  <button 
                    onClick={() => setViewerIndex(null)} 
                    className="bg-white/10 backdrop-blur-md p-3.5 rounded-2xl text-white hover:bg-white/20 border border-white/10 transition-all"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                </div>
              </div>

              {/* Main Visual Component */}
              <div className="flex-1 relative flex items-center justify-center overflow-hidden">
                <img 
                  src={getImageUrl(activeItem["Link Drive"], 'w1600')} 
                  className="max-h-full max-w-full object-contain md:p-10 animate-zoom viewer-image" 
                  key={activeItem["No Pohon"]} 
                />
                
                {/* Desktop Side Controls */}
                <button onClick={goPrev} className="hidden md:flex absolute left-10 p-7 bg-white/5 hover:bg-white/10 rounded-full text-white backdrop-blur-md transition-all disabled:opacity-0 border border-white/10" disabled={viewerIndex === 0}>
                  <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button onClick={goNext} className="hidden md:flex absolute right-10 p-7 bg-white/5 hover:bg-white/10 rounded-full text-white backdrop-blur-md transition-all disabled:opacity-0 border border-white/10" disabled={viewerIndex === filtered.length - 1}>
                  <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M9 5l7 7-7 7" /></svg>
                </button>
              </div>

              {/* Advanced Data Footer */}
              <div className="p-8 md:p-12 glass-dark border-t border-white/5 bg-gradient-to-t from-black to-slate-900/50">
                <div className="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-10">
                  <div className="text-center lg:text-left flex-1">
                    <h2 className="text-4xl md:text-5xl font-black uppercase italic tracking-tighter mb-3 leading-none">{activeItem.Tanaman}</h2>
                    <p className="text-blue-500 text-sm font-black tracking-[0.3em] uppercase">Inventory ID: #{activeItem["No Pohon"]} • Surveyor: {activeItem.Pengawas || 'N/A'}</p>
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full lg:w-auto text-center">
                    <div className="bg-white/5 p-5 rounded-[2rem] border border-white/5 backdrop-blur-md">
                      <p className="text-[9px] font-black text-slate-500 uppercase mb-2 tracking-widest">Tinggi</p>
                      <p className="text-xl font-black">{activeItem.Tinggi} <span className="text-[10px] text-blue-500">CM</span></p>
                    </div>
                    <div className="bg-white/5 p-5 rounded-[2rem] border border-white/5 backdrop-blur-md">
                      <p className="text-[9px] font-black text-slate-500 uppercase mb-2 tracking-widest">Status</p>
                      <p className="text-xl font-black">{activeItem.Kesehatan}</p>
                    </div>
                    <div className="bg-white/5 p-5 rounded-[2rem] border border-white/5 backdrop-blur-md">
                      <p className="text-[9px] font-black text-slate-500 uppercase mb-2 tracking-widest">Tanggal</p>
                      <p className="text-[10px] font-black leading-tight mt-1">{activeItem.Tanggal}</p>
                    </div>
                    <div className="bg-white/5 p-5 rounded-[2rem] border border-white/5 backdrop-blur-md">
                      <p className="text-[9px] font-black text-slate-500 uppercase mb-2 tracking-widest">Koordinat</p>
                      <p className="text-[10px] font-black leading-tight text-emerald-400 mt-1">{activeItem.X}, {activeItem.Y}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Delete Processing Mask */}
          {isDeleting && (
            <div className="fixed inset-0 z-[11000] bg-red-600/95 flex flex-col items-center justify-center p-6 text-white text-center">
              <div className="w-20 h-20 border-[8px] border-white/20 border-t-white rounded-full animate-spin mb-8"></div>
              <h2 className="text-4xl font-black uppercase italic tracking-tighter">Sinkronisasi Database...</h2>
              <p className="text-[11px] font-black uppercase tracking-[0.4em] opacity-60 mt-4">Menghapus Aset Dari Mission Control</p>
            </div>
          )}

          <PasswordModal 
            isOpen={deleteTarget !== null} 
            onCancel={() => setDeleteTarget(null)} 
            onSubmit={handleDelete} 
          />
        </div>
      );
    };

    const container = document.getElementById('root');
    const root = createRoot(container);
    root.render(React.createElement(App));
  </script>
</body>
</html>
